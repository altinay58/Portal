ALTER TABLE [dbo].[StandartProjeIsleri]
	ADD StandartProjeIsleriAciklama nvarchar(250) NULL

ALTER TABLE [dbo].[StandartProjeIsleri]
	ADD StandartProjeIsleriIdAnahtarIsmi nvarchar(100) NULL

ALTER TABLE [dbo].[StandartProjeIsleri]
	ADD StandartProjeIsleriIdKontrol bit NULL
--------------------------------------------------------
ALTER TABLE [dbo].[isler]
	ADD islerIsinDurumu int not NULL default(1)
	
---------------------------------------------------------
--[17:53, 11.1.2017] +90 545 871 3724: SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[DomainKayitliFirma](
	[DomainKayitliFirmaId] [int] IDENTITY(1,1) NOT NULL,
	[DomainKayitliFirmaAdi] [nvarchar](250) NULL,
	[Aciklama] [nvarchar](250) NULL,
 CONSTRAINT [PK_DomainKayitliFirma] PRIMARY KEY CLUSTERED 
(
	[DomainKayitliFirmaId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
--insert
insert into DomainKayitliFirma
           (DomainKayitliFirmaAdi,Aciklama)
     select KayitliFirmaAdi,Aciklama from KayitliFirma                        
--[19:00, 11.1.2017] +90 545 871 3724: Domain table yeni kolumn eklendi script assagida                        
--[19:00, 11.1.2017] +90 545 871 3724: 
alter table Domain add RefDomainKayitliFirmaId int not null default(1)


ALTER TABLE [dbo].[Domain]  WITH CHECK ADD  CONSTRAINT [FK_Domain_DomainKayitliFirma] FOREIGN KEY([RefDomainKayitliFirmaId])
REFERENCES [dbo].[DomainKayitliFirma] ([DomainKayitliFirmaId])
GO

ALTER TABLE [dbo].[Domain] CHECK CONSTRAINT [FK_Domain_DomainKayitliFirma]
GO

ALTER TABLE [dbo].[Domain]  WITH CHECK ADD  CONSTRAINT [FK_Domain_DomainKayitliFirma] FOREIGN KEY([RefDomainKayitliFirmaId])
REFERENCES [dbo].[DomainKayitliFirma] ([DomainKayitliFirmaId])
GO

ALTER TABLE [dbo].[Domain] CHECK CONSTRAINT [FK_Domain_DomainKayitliFirma]
GO

update Domain set RefKayitliFirmaID = RefDomainKayitliFirmaId
----------------------------------------------------------
ALTER TABLE [dbo].[Arayanlar]
	ADD ArayanAraciAdi nvarchar(100) NULL
----------------------------------------------------------

ALTER TABLE [dbo].[isler]
	ADD islerGelisYontemi nvarchar(100) NULL
ALTER TABLE [dbo].[isler]
	ADD islerBitisTarihiVarmi bit not null default(0)

ALTER TABLE [dbo].[isler]
	ADD islerBitisTarihi date null 
----------------------------------------------------------
ALTER TABLE [dbo].[Arayanlar]
	ADD arayanRefislerId int  NULL

ALTER TABLE [dbo].[Arayanlar]  WITH CHECK ADD  CONSTRAINT [FK_Arayanlar_isler] FOREIGN KEY([arayanRefislerId])
REFERENCES [dbo].[isler] ([islerID])
GO

ALTER TABLE [dbo].[Arayanlar] CHECK CONSTRAINT [FK_Arayanlar_isler]
GO
-----------------------------------------------------------
ALTER TABLE [dbo].[Arayanlar]   drop  CONSTRAINT [FK_Arayanlar_isler] 
GO
ALTER TABLE [dbo].[Arayanlar]
	drop column arayanRefislerId 
----------------------------------------------------------
ALTER TABLE [dbo].[Arayanlar]
	ADD arayanMailSablonuId int  NULL

ALTER TABLE [dbo].[Arayanlar]  WITH CHECK ADD  CONSTRAINT [FK_Arayanlar_MailSablanlari] FOREIGN KEY([arayanMailSablonuId])
REFERENCES [dbo].[MailSablonu] ([MailSablonuID])
GO

ALTER TABLE [dbo].[Arayanlar] CHECK CONSTRAINT [FK_Arayanlar_MailSablanlari]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[ArayanListesi]
AS

select *
from
(
SELECT top 1000   Extent1.arayanID AS Id, CASE WHEN ([Extent1].[arayanAdi] IS NULL) THEN N'' ELSE [Extent1].[arayanAdi] END + N' ' + CASE WHEN ([Extent1].[arayanSoyadi] IS NULL) THEN N'' ELSE [Extent1].[arayanSoyadi] END AS AdSoyad, 
                Extent1.arayanFirmaAdi AS Firma, Extent1.arayanTelefonNo AS Tel, Extent1.arayanCepTelNo AS CepTel, Extent1.arayanNot AS Note, Extent3.MailSablonuAdi AS MailDurum, Extent2.islerID AS Ticket,
				Extent1.arayanKayitTarih as Tarih,FORMAT(Extent1.arayanKayitTarih, 'dd.MM.yyyy HH:mm') as StrTarih,Extent1.arayanFirmaKayitDurum as KayitDurum,k.Konum as Bolge

FROM      dbo.Arayanlar AS Extent1 LEFT OUTER JOIN
                dbo.isler AS Extent2 ON Extent1.arayanID = Extent2.islerRefArayanID LEFT OUTER JOIN
                dbo.MailSablonu AS Extent3 ON Extent1.arayanMailSablonuId = Extent3.MailSablonuID LEFT OUTER JOIN
                dbo.Firma AS Extent4 ON Extent1.arayanKayitliRefFirmaID = Extent4.FirmaID LEFT OUTER JOIN
				dbo.Konum as k on Extent1.arayanRefKonumID=k.KonumID
order by Tarih desc
 ) T
GO
--------------------------------------------------------------
--24.01.2017
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[DomainNot](
	[DomainNotId] [int] IDENTITY(1,1) NOT NULL,
	[DomainNotNot] [nvarchar](300) NULL,
	[DomainNotTarih] [datetime] NULL,
	[RefNotKullaniciId] [nvarchar](128) NULL,
 CONSTRAINT [PK_DomainNot] PRIMARY KEY CLUSTERED 
(
	[DomainNotId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [dbo].[DomainNot] ADD  CONSTRAINT [DF_DomainNot_DomainNotTarih]  DEFAULT (getdate()) FOR [DomainNotTarih]
GO

ALTER TABLE [dbo].[DomainNot]  WITH CHECK ADD  CONSTRAINT [FK_Domain_RefKayitYapanKullanici] FOREIGN KEY([RefNotKullaniciId])
REFERENCES [dbo].[AspNetUsers] ([Id])
GO

ALTER TABLE [dbo].[DomainNot] CHECK CONSTRAINT [FK_Domain_RefKayitYapanKullanici]
GO

/****** Object:  Table [dbo].[ZamanIs]    Script Date: 24.01.2017 13:44:13 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[ZamanIs](
	[ZamanIsId] [int] IDENTITY(1,1) NOT NULL,
	[RefIsId] [int] NOT NULL,
	[ZamanIsBasTarih] [datetime] NOT NULL,
	[GecenZamanSaniye] [bigint] NULL,
 CONSTRAINT [PK_ZamanIs] PRIMARY KEY CLUSTERED 
(
	[ZamanIsId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [dbo].[ZamanIs]  WITH CHECK ADD  CONSTRAINT [FK_Domain_RefIsId] FOREIGN KEY([RefIsId])
REFERENCES [dbo].[isler] ([islerID])
GO

ALTER TABLE [dbo].[ZamanIs] CHECK CONSTRAINT [FK_Domain_RefIsId]
GO

ALTER TABLE [dbo].[isler]
	ADD islerSiraNo int NULL
---------26.01.17
GO
ALTER TABLE [dbo].[DomainNot]
ADD RefDomainId int not NULL

GO
ALTER TABLE [dbo].[DomainNot]  WITH CHECK ADD  CONSTRAINT [FK_Domain_RefDomainId] FOREIGN KEY([RefDomainId])
REFERENCES [dbo].[Domain] ([DomainID])
GO
ALTER TABLE [dbo].[Domain]
ADD DomainAksiyon int not null default(2)
GO
/****** Object:  Table [dbo].[FirmaKisi]    Script Date: 27.01.2017 23:33:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[FirmaKisi](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Ad] [nvarchar](50) NULL,
	[Soyad] [nvarchar](50) NULL,
	[Departman] [nvarchar](50) NULL,
	[Tel] [nvarchar](50) NULL,
	[Email] [nvarchar](50) NULL,
	[FirmaId] [int] NOT NULL,
 CONSTRAINT [PK_FirmaKisi] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [dbo].[FirmaKisi]  WITH CHECK ADD  CONSTRAINT [FK_FirmaKisi_Firma] FOREIGN KEY([FirmaId])
REFERENCES [dbo].[Firma] ([FirmaID])
GO

ALTER TABLE [dbo].[FirmaKisi] CHECK CONSTRAINT [FK_FirmaKisi_Firma]
GO
---31.01.2017
ALTER TABLE [dbo].[Domain]
ADD SatisOncelikli bit not NULL default(0)
GO
ALTER TABLE [dbo].[Domain]
ADD GuncellemeSozlesmesiVarmi bit not NULL default(0)
GO
ALTER TABLE [dbo].[Domain]
ADD OdemesiAlindi bit not NULL default(0)
GO
----
GO

/****** Object:  View [dbo].[RandevularView]    Script Date: 4.02.2017 00:59:37 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[RandevularView]
AS
SELECT    RandevuID,RandevuRefFirmaID, RandevuYeri, RandevuTarihi, CASE WHEN RandevuRefFirmaID IS NOT NULL THEN
                    (SELECT   TOP 1 k.Konum
                     FROM      Konum k, Firma f
                     WHERE   f.FirmaID = [RandevuRefFirmaID] AND f.RefKonumID = k.KonumID) ELSE
                    (SELECT   TOP 1 k.Konum
                     FROM      Konum k, Arayanlar a
                     WHERE   a.arayanID = [RandevuRefArayanID] AND a.arayanRefKonumID = k.KonumID) END AS Bolge, CASE WHEN RandevuRefFirmaID IS NOT NULL THEN
                    (SELECT   TOP 1 f.FirmaAdi + ' / ' + f.YetkiliAdi + ' ' + f.YetkiliSoyAdi
                     FROM      Firma f
                     WHERE   f.FirmaID = [RandevuRefFirmaID]) ELSE
                    (SELECT   TOP 1 a.arayanFirmaAdi + ' / ' + a.arayanAdi + ' ' + a.arayanSoyadi
                     FROM      Arayanlar a
                     WHERE   a.arayanID = [RandevuRefArayanID]) END AS Firma,
                    (SELECT   TOP (1) Isim
                     FROM      dbo.AspNetUsers AS a
                     WHERE   (Id = dbo.Randevu.RandevuYetkiliKisiID)) AS Kiminle
FROM      dbo.Randevu
GO
-----------------------


/****** Object:  UserDefinedFunction [dbo].[IsiYapanKullaniciAdSoyad]    Script Date: 17.02.2017 13:54:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[IsiYapanKullaniciAdSoyad]
(
	-- Add the parameters for the function here
	@isId int
)
RETURNS varchar(3000)
AS
BEGIN
	-- Declare the return variable here
	 declare @results varchar(3000)
	

	-- Add the T-SQL statements to compute the return value here
	select @results = coalesce(@results + ',', '') +  convert(varchar(128),a.Isim+' '+a.SoyIsim)
from IsiYapacakKisi y inner join AspNetUsers a on(y.RefIsiYapacakKisiUserID=a.Id)
where RefIsID=@isId


	-- Return the result of the function
	RETURN @results

END

GO
-----------------------

---------------------------------------------
--25.02.2017
--CariHareket tablosuna RefSatisId ozelligi eklendi
  GO
  ALTER TABLE [dbo].[CariHareket]
	ADD RefSatisId int NULL
GO
ALTER TABLE [dbo].[CariHareket]  WITH CHECK ADD  CONSTRAINT [FK_Satis_RefSatidId] FOREIGN KEY([RefSatisId])
REFERENCES [dbo].[Satis] ([SatisID])
--01.03.2017
GO
ALTER TABLE [dbo].[Domain] ADD Note nvarchar (150) NULL
-----------------------------------------------------------------
--04.03.2017 mesai cizelgesi
GO

/****** Object:  Table [dbo].[MesaiCizelgesi]    Script Date: 5.03.2017 00:47:43 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[MesaiCizelgesi](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Tarih] [date] NOT NULL,
	[GirisSaat] [nchar](10) NULL,
	[CikisSaat] [nchar](10) NULL,
	[MesaiSuresi] [decimal](18, 2) NULL,
	[Durum] [int] NULL,
	[KullaniciId] [nvarchar](128) NOT NULL,
 CONSTRAINT [PK_MesaiCizelgesi] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
---------------------------------------------------------------------
--09.03.2017
-- içerik formu için
 insert into Ayar(AyarAdi,AyarDeger)values('IcerikFormuIsAtanacakKullanici','d8c319cd-1e3b-40a7-b6fb-fb2861dcf720')
 insert into Ayar(AyarAdi,AyarDeger)values('IcerikFormuIsKontrolEdenKullanici','2f8e03fe-8234-431f-8c71-f1a16a301af8')
--------------------------------------------------------------------------------------
--10.03.2017
--todo list
/****** Object:  Table [dbo].[ToDo]    Script Date: 10.03.2017 16:23:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[ToDo](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[KulId] [nvarchar](128) NOT NULL,
	[Aciklama] [nvarchar](max) NULL,
	[Durum] [int] NOT NULL CONSTRAINT [DF_ToDo_Durum]  DEFAULT ((0)),
	[Tarih] [datetime] NOT NULL CONSTRAINT [DF_ToDo_Tarih]  DEFAULT (getdate()),
 CONSTRAINT [PK_ToDo] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO
----
--13.03.2017
GO

/****** Object:  View [dbo].[IslerListesi]    Script Date: 13.03.2017 13:49:25 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[IslerListesi]
AS

select i.islerID as Id,i.islerAdi as IsAdi,f.FirmaAdi as Firma,d.DomainAdi as Domain,
(SELECT   TOP 1 a.Isim+' '+a.SoyIsim FROM      dbo.AspNetUsers AS a WHERE i.islerisiVerenKisi=a.Id ) AS IsiVerenKisi
,dbo.IsiYapanKullaniciAdSoyad(i.islerID) as IsiYapacakKisi,
(case i.islerIsinDurumu  when 1 then 'Yapılacak'
                         when 2 then 'YapılacakDeadline'
						 when 3 then 'Yapiliyor'
						 when 4 then 'KontrolBekleyen'
						 when 5 then 'Biten'
						 end
) as IsinDurumu,i.islerTarih Tarih
from isler i inner join firma f on (i.islerRefFirmaID=f.FirmaID)
     inner join Domain d on (i.islerRefDomainID=d.DomainID)



GO
----
--resim yolu eklendi
ALTER TABLE [dbo].[Tema] ADD ResimYolu nvarchar (400) NULL
---

/****** Object:  View [dbo].[IslerListesi]    Script Date: 14.03.2017 23:54:34 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[IslerListesi]
AS

select i.islerID as Id,i.islerAdi as IsAdi,f.FirmaAdi as Firma,d.DomainAdi as Domain,
(SELECT   TOP 1 a.Isim+' '+a.SoyIsim FROM      dbo.AspNetUsers AS a WHERE i.islerisiVerenKisi=a.Id ) AS IsiVerenKisi
,dbo.IsiYapanKullaniciAdSoyad(i.islerID) as IsiYapacakKisi,
(case i.islerIsinDurumu  when 1 then 'Yapilacak'
                         when 2 then 'YapilacakDeadline'
						 when 3 then 'Yapiliyor'
						 when 4 then 'KontrolBekleyen'
						 when 5 then 'Biten'
						 end
) as IsinDurumu,i.islerTarih Tarih,i.islerRefDomainID as DomainId
from isler i inner join firma f on (i.islerRefFirmaID=f.FirmaID)
     inner join Domain d on (i.islerRefDomainID=d.DomainID)




GO

----eski iskarayel den yeni portal iş durumlarını akatarma
--15.03.2017

update isler set islerIsinDurumu=4 where islerinisinOnayDurumu=0 and islerisinTamamlanmaDurumu=1  --onay bekleyen


update isler set islerIsinDurumu=5 where islerinisinOnayDurumu=1 and islerisinTamamlanmaDurumu=1  -- biten








